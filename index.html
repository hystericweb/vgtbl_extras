<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tabela (no letter tiles + plain col3)</title>
<style>
  :root{
    --maxw: 1200px;
    --radius: 6px;
    --border: 1px;
    --space-1: 6px;
    --space-2: 10px;
    --space-3: 14px;
    --space-4: 20px;
    --space-5: 28px;
    --space-6: 40px;
    --bg-hover: rgba(255, 255, 255, 0.1);
    --fg: #fff;
    --bd: #555;
    --letter-bg: #2a2a2a;
    --letter-hover-bg: #404040;
    --accent: #9ec1ff;
  }

  *{ box-sizing: border-box; }

  html, body { height: auto; overflow-x: hidden; overflow-y: visible; }

  body{
    font-family: 'Roboto', monospace;
    margin: 0;
    color: var(--fg);
    padding-inline: clamp(24px, 5vw, 72px);
    padding-block: 16px;
    background: transparent;
  }

  .wrap{
    max-width: var(--maxw);
    margin-inline: auto;
    width: 100%;
    background: #1a1a1a;
    border-radius: 16px;
    padding: var(--space-4);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  /* Info bar */
  #loading, #error {
    font-weight: 500;
    font-size: clamp(12px, 2.5vw, 18px);
    text-align: center;
    margin: var(--space-4) 0;
    color: var(--fg);
    font-family: 'Roboto', Arial, sans-serif;
  }
  #error{ color: #ff6b6b; }

  .table-scroll{ width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }

  table{
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 var(--space-3);
    min-width: 100%;
    table-layout: fixed;
  }

  th, td{
    border: none;
    padding: clamp(12px, 2vw, 22px);
    font-weight: normal;
    font-size: clamp(14px, 1.8vw, 20px);
    background: transparent;
    min-height: 44px;
    vertical-align: middle;
    white-space: nowrap; /* default: single line */
    overflow: visible;
  }

  /* Balanced horizontal spacing between columns */
  td:first-child { padding-right: var(--space-2); }
  td + td { padding-left: var(--space-2); }

  /* Column-specific tweaks */
  /* Col 1 (date) stays compact; Col 2 (city) uses pills; Col 3 (plain text) wraps naturally */
  td:nth-child(3){ white-space: normal; }

  tr{
    transition: background-color .15s ease;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 6px;
  }
  tr:hover { cursor: pointer; background: rgba(255, 255, 255, 0.1); }
  tr[tabindex]:focus-visible { outline: 2px solid #4a9eff; outline-offset: 2px; }

  @media (max-width: 600px){
    table { table-layout: auto; border-spacing: 0 var(--space-2); }
    th, td{
      padding: clamp(8px, 3vw, 16px);
      white-space: normal;      /* allow wrap on words */
      word-break: normal;       /* keep words intact */
      overflow-wrap: normal;    /* avoid breaking inside words */
      -webkit-hyphens: none;
      hyphens: manual;
      vertical-align: top;
      line-height: 1.35;
    }
    td:first-child { padding-right: var(--space-1); }
    td + td { padding-left: var(--space-1); }
  }

  /* ====== Word pills (used for non-plain cells) ====== */
  .magnet-word{
    display: inline-flex;
    align-items: center;
    margin: 2px 6px 2px 0;
    padding: 6px 10px;
    background: var(--letter-bg);
    border-radius: 999px;
    font-weight: 700;
    line-height: 1.1;
    white-space: nowrap;      /* keep each word on a single line */
    box-shadow: 0 1px 2px rgba(0,0,0,.25);
  }

  /* No per-letter tiles at all */
  /* .magnet-text removed intentionally */

  /* ====== Compact vertical date badge ====== */
  .date-compact{
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1;
    background: #111a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 4px 8px;
    min-width: 36px;
    box-shadow: 0 1px 2px rgba(0,0,0,.25);
    vertical-align: middle;
    margin-right: 8px; /* tight gap to city */
  }
  .date-compact .day{ font-size: clamp(16px, 2.6vw, 20px); font-weight: 800; letter-spacing: 0.3px; }
  .date-compact .month{ font-size: clamp(10px, 1.6vw, 12px); font-weight: 700; opacity: 0.9; letter-spacing: 0.4px; margin-top: 2px; }

  @media (max-width: 600px){ .date-compact{ margin-right: 6px; } }
</style>
</head>
<body>
  <div class="wrap">
    <div id="loading">Ładowanie…</div>
    <div id="error" style="display:none;">Błąd ładowania danych</div>

    <div class="table-scroll">
      <table id="dataTable" style="display:none;">
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

<script>
  /* ===== Helpers ===== */
  function isNarrow(){ return (typeof window !== 'undefined') && window.innerWidth <= 600; }

  // Render word pills (used for most text cells)
  function renderWords(text){
    const words = String(text ?? '').trim().split(/\s+/);
    return words.map(w=> `<span class=\"magnet-word\">${escapeHTML(w)}</span>`).join(' ');
  }

  // Plain text (no pills); for column 3
  function renderPlain(text){
    const span = document.createElement('span');
    span.textContent = String(text ?? '');
    return span.outerHTML;
  }

  function escapeHTML(s){
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/\"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  /* ===== Date detection & formatting ===== */
  function parseDateLoose(s){
    if(!s) return null;
    const str = String(s).trim();

    const isoLike = /^(\d{4})[-\/\.](\d{1,2})[-\/\.](\d{1,2})$/;
    const euLike  = /^(\d{1,2})[-\/\.](\d{1,2})[-\/.](\d{2,4})$/;

    let y, m, d;
    if(isoLike.test(str)){
      const [,yy, mm, dd] = str.match(isoLike); y = +yy; m = +mm; d = +dd;
    } else if(euLike.test(str)){
      const [,dd, mm, yy] = str.match(euLike); d = +dd; m = +mm; y = (String(yy).length===2 ? (2000 + +yy) : +yy);
    } else {
      const tryD = new Date(str);
      if(!isNaN(tryD)){ y = tryD.getFullYear(); m = tryD.getMonth()+1; d = tryD.getDate(); }
      else { return null; }
    }

    if(m<1 || m>12 || d<1 || d>31 || y<1900 || y>3000) return null;

    const monthStr = new Date(y, m-1, d).toLocaleString('en-US', { month: 'short' }).toUpperCase();
    const dayStr = String(d).padStart(2,'0');
    const iso = `${y}-${String(m).padStart(2,'0')}-${dayStr}`;
    return { day: dayStr, mon: monthStr, iso };
  }

  function renderDateCompact(dateStr){
    const p = parseDateLoose(dateStr);
    if(!p) return null;
    const {day, mon, iso} = p;
    return `
      <span class=\"date-compact\" aria-label=\"${escapeHTML(dateStr)} (${iso})\" title=\"${escapeHTML(dateStr)}\">\n        <span class=\"day\">${day}</span>\n        <span class=\"month\">${mon}</span>\n      </span>
    `;
  }

  /* ===== CSV parser (handles quotes & commas) ===== */
  function parseCSV(csvText){
    const rows = [];
    let i = 0, field = '', inQuotes = false, row = [];
    while(i < csvText.length){
      const c = csvText[i];
      if(c === '"'){
        if(inQuotes && csvText[i+1] === '"'){ field += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if(c === ',' && !inQuotes){
        row.push(field); field = '';
      } else if((c === '\n' || c === '\r') && !inQuotes){
        if(field.length || row.length){ row.push(field); rows.push(row); }
        field = ''; row = [];
        if(c === '\r' && csvText[i+1] === '\n') i++;
      } else { field += c; }
      i++;
    }
    if(field.length || row.length){ row.push(field); rows.push(row); }
    return rows;
  }

  /* ===== Data loading & rendering ===== */
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQM_hD_qj2loea8TYCQL_QEGnIs2G437HniXMT3UJ5IDc8Grr0qrtMnEzd1cZjOqQtfqPv7RSN1OkhU/pub?gid=0&single=true&output=csv';

  let cachedRows = null;
  let lastRenderNarrow = null;

  async function loadData(){
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    try{
      const res = await fetch(CSV_URL, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const csvText = await res.text();
      cachedRows = parseCSV(csvText);
      displayTable(cachedRows);
      loadingEl.style.display = 'none';
    }catch(e){
      loadingEl.style.display = 'none';
      errorEl.style.display = 'block';
      console.error(e);
    }
  }

  function displayTable(rows){
    const table = document.getElementById('dataTable');
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    if(rows && rows.length > 1){
      for(let i = 1; i < rows.length; i++){
        const rowData = rows[i];
        if(!rowData || rowData.length === 0) continue;

        const tr = document.createElement('tr');
        tr.setAttribute('tabindex', '0');

        const linkUrl = (rowData[rowData.length - 1] || '').trim();
        if(linkUrl){
          tr.addEventListener('click', ()=> window.open(linkUrl, '_blank', 'noopener'));
          tr.addEventListener('keydown', (ev)=>{
            if(ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); window.open(linkUrl, '_blank', 'noopener'); }
          });
        }

        for(let j = 0; j < rowData.length - 1; j++){
          const td = document.createElement('td');
          const cell = rowData[j] || '';

          // 1) Try date compact renderer
          const dateHTML = renderDateCompact(cell);
          if(dateHTML){
            td.innerHTML = dateHTML;
          } else {
            // Column 3: render plain text (no word bubbles)
            if(j === 2){
              td.innerHTML = renderPlain(cell);
            } else {
              // Other columns: word pills
              td.innerHTML = renderWords(cell);
            }
          }

          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }
    table.style.display = 'table';
    lastRenderNarrow = isNarrow();
    postResize();
  }

  /* Resize messaging for embedded scenarios + re-render on threshold switch */
  function postResize(){
    const height = document.documentElement.scrollHeight;
    if(window.parent && window.parent !== window){
      try{ window.parent.postMessage({ type: 'resize', height }, '*'); }catch(e){ /* ignore cross-origin */ }
    }
  }
  function debounce(fn, wait=150){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(null,args), wait); }; }

  window.addEventListener('load', ()=>{
    loadData();

    // Re-render when crossing the 600px threshold (not strictly needed now, but kept for consistency)
    window.addEventListener('resize', debounce(()=>{
      const nowNarrow = isNarrow();
      if(cachedRows && lastRenderNarrow !== null && nowNarrow !== lastRenderNarrow){
        displayTable(cachedRows);
      } else {
        postResize();
      }
    }, 150));

    if('ResizeObserver' in window){
      const ro = new ResizeObserver(debounce(postResize, 50));
      ro.observe(document.body);
    } else { setInterval(postResize, 500); }
  });
</script>
</body>
</html>
